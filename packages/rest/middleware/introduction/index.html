<!DOCTYPE html>
<html>
<head>
    <title></title>
    <link rel="stylesheet" href="/public/assets/pico.min.css">
    <link rel="stylesheet" href="/public/assets/prism.css">
    <link rel="stylesheet" href="/public/assets/style.css">
    <script src="/public/assets/prism.js"></script>
</head>
<body>
<header>
    <nav>
    <a href="https://www.github.com/phpnomad">GitHub</a>
</nav></header>

<div class="docs-layout">
    <aside class="docs-sidebar">
                    <a href="/"><img src="/public/assets/logo.png" alt="PHPNomad Logo"/></a>
            <nav>
    
                                        <details class="nav-section" >
                    <summary>
                                                    Core concepts
                                            </summary>
                    <div class="nav-group">
                                                            <details class="nav-section" >
                    <summary>
                                                    Bootstrapping
                                            </summary>
                    <div class="nav-group">
                                                            <div class="nav-item">
                    <a href="/core-concepts/bootstrapping/advanced-bootstrapping" class="">
                        Advanced bootstrapping
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/core-concepts/bootstrapping/creating-and-managing-initializers" class="">
                        Creating and managing initializers
                    </a>
                </div>
                                                <details class="nav-section" >
                    <summary>
                                                    Initializers
                                            </summary>
                    <div class="nav-group">
                                                            <div class="nav-item">
                    <a href="/core-concepts/bootstrapping/initializers/event-binding" class="">
                        Event binding
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/core-concepts/bootstrapping/initializers/event-listeners" class="">
                        Event listeners
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/core-concepts/bootstrapping/initializers/facades" class="">
                        Facades
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/core-concepts/bootstrapping/initializers/rest-controllers" class="">
                        Rest controllers
                    </a>
                </div>
                        
                    </div>
                </details>
                                                <div class="nav-item">
                    <a href="/core-concepts/bootstrapping/introduction" class="">
                        Introduction
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/core-concepts/bootstrapping/platform-integrations" class="">
                        Platform integrations
                    </a>
                </div>
                        
                    </div>
                </details>
                        
                    </div>
                </details>
                                                <details class="nav-section" open>
                    <summary>
                                                    Packages
                                            </summary>
                    <div class="nav-group">
                                                            <details class="nav-section" open>
                    <summary>
                                                    Rest
                                            </summary>
                    <div class="nav-group">
                                                            <div class="nav-item">
                    <a href="/packages/rest/controllers" class="">
                        Controllers
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/packages/rest/integration-guide" class="">
                        Integration guide
                    </a>
                </div>
                                                <details class="nav-section" >
                    <summary>
                                                    Interceptors
                                            </summary>
                    <div class="nav-group">
                                                            <details class="nav-section" >
                    <summary>
                                                    Included interceptors
                                            </summary>
                    <div class="nav-group">
                                                            <div class="nav-item">
                    <a href="/packages/rest/interceptors/included-interceptors/event-interceptor" class="">
                        Event interceptor
                    </a>
                </div>
                        
                    </div>
                </details>
                                                <div class="nav-item">
                    <a href="/packages/rest/interceptors/introduction" class="">
                        Introduction
                    </a>
                </div>
                        
                    </div>
                </details>
                                                <div class="nav-item">
                    <a href="/packages/rest/introduction" class="">
                        Introduction
                    </a>
                </div>
                                                <details class="nav-section" open>
                    <summary>
                                                    Middleware
                                            </summary>
                    <div class="nav-group">
                                                            <details class="nav-section" >
                    <summary>
                                                    Included middleware
                                            </summary>
                    <div class="nav-group">
                                                            <div class="nav-item">
                    <a href="/packages/rest/middleware/included-middleware/callback-middleware" class="">
                        Callback middleware
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/packages/rest/middleware/included-middleware/parse-jwt-middleware" class="">
                        Parse jwt middleware
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/packages/rest/middleware/included-middleware/set-type-middleware" class="">
                        Set type middleware
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/packages/rest/middleware/included-middleware/validation-middleware" class="">
                        Validation middleware
                    </a>
                </div>
                        
                    </div>
                </details>
                                                <div class="nav-item">
                    <a href="/packages/rest/middleware/introduction" class="">
                        Introduction
                    </a>
                </div>
                        
                    </div>
                </details>
                                                <details class="nav-section" >
                    <summary>
                                                    Validations
                                            </summary>
                    <div class="nav-group">
                                                            <details class="nav-section" >
                    <summary>
                                                    Included validations
                                            </summary>
                    <div class="nav-group">
                                                            <div class="nav-item">
                    <a href="/packages/rest/validations/included-validations/is-any" class="">
                        Is any
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/packages/rest/validations/included-validations/is-email" class="">
                        Is email
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/packages/rest/validations/included-validations/is-greater-than" class="">
                        Is greater than
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/packages/rest/validations/included-validations/is-numeric" class="">
                        Is numeric
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/packages/rest/validations/included-validations/is-type" class="">
                        Is type
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/packages/rest/validations/included-validations/keys-are-any" class="">
                        Keys are any
                    </a>
                </div>
                        
                    </div>
                </details>
                                                <div class="nav-item">
                    <a href="/packages/rest/validations/introduction" class="">
                        Introduction
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/packages/rest/validations/validation-set" class="">
                        Validation set
                    </a>
                </div>
                        
                    </div>
                </details>
                        
                    </div>
                </details>
                                                <details class="nav-section" >
                    <summary>
                                                    Utils
                                            </summary>
                    <div class="nav-group">
                                                            <div class="nav-item">
                    <a href="/packages/utils/array-helper" class="">
                        Array helper
                    </a>
                </div>
                                                <details class="nav-section" >
                    <summary>
                                                    Processors
                                            </summary>
                    <div class="nav-group">
                                                            <div class="nav-item">
                    <a href="/packages/utils/processors/array-processor" class="">
                        Array processor
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/packages/utils/processors/list-filter" class="">
                        List filter
                    </a>
                </div>
                                                <div class="nav-item">
                    <a href="/packages/utils/processors/list-sorter" class="">
                        List sorter
                    </a>
                </div>
                        
                    </div>
                </details>
                        
                    </div>
                </details>
                        
                    </div>
                </details>
                        
</nav>            </aside>
    <main class="docs-content">
            <h1 id="middleware">Middleware</h1>
<p>Middleware is the <strong>pre-controller</strong> layer of <code>phpnomad/rest</code>. It runs before your controller’s business logic, shaping
the request into something predictable and safe to operate on. Typical uses include setting sane defaults, coercing
types, enriching context, and—when necessary—stopping a request early.</p>
<p>By the time a request reaches your controller, well-behaved middleware should have already done the boring work:
normalize parameters, apply limits, gate obvious failures, and authorize/authenticate the request.</p>
<h2 id="what-middleware-is-responsible-for">What middleware is responsible for</h2>
<p>Middleware has two clear responsibilities:</p>
<ol>
<li>
<p>Prepare the request Normalize or enrich input so controllers can keep their focus. This might be pagination defaults,
converting a CSV
into an array, or attaching derived context for later phases.</p>
</li>
<li>
<p>Short-circuit when appropriate If something is clearly wrong (unauthorized, missing resource, exceeded limit),
middleware can stop the request
<em>before</em> controller code runs. The recommended way to do this is to <strong>throw a <code>RestException</code></strong> with an HTTP status
code, message, and structured context—the integration will catch it and format the HTTP response consistently.</p>
</li>
</ol>
<h2 id="what-middleware-is-not">What middleware is not</h2>
<ol>
<li>It is not where you perform post-response side effects, such as triggering events. That's the job
of <a href="../interceptors/introduction">interceptors</a></li>
<li>It is not where you encode your domain’s validation rules. That's the job
of <a href="../validations/introduction">validations</a>.</li>
<li>It is not where you write business logic. That's the job of the controller.</li>
</ol>
<h2 id="the-middleware-contract">The middleware contract</h2>
<p>A middleware class implements the <code>PHPNomad\Rest\Interfaces\Middleware</code> interface and defines a single method:</p>
<pre><code class="language-php">public function process(\PHPNomad\Http\Interfaces\Request $request): void;
</code></pre>
<ul>
<li><strong>Input:</strong> a normalized <code>Request</code> object you can read and mutate
via <code>getParam</code>, <code>hasParam</code>, <code>setParam</code>, <code>removeParam</code>, and friends.</li>
<li><strong>Output:</strong> no return value. Either mutate the request in place and return, or throw a <code>RestException</code> to
short-circuit with an error.</li>
</ul>
<p>Like controllers, middleware can use <strong>constructor injection</strong>. Because instances are created via your initializer and
container, you can request collaborators (repositories, services, strategies) in the constructor without manual wiring.</p>
<h2 id="example-pagination-defaults">Example: pagination defaults</h2>
<p>This middleware ensures that all list endpoints have sensible pagination. Controllers don’t need to know anything about
defaults or caps; they simply read <code>number</code> and <code>offset</code>.</p>
<pre><code class="language-php">&lt;?php

use PHPNomad\Rest\Interfaces\Middleware;
use PHPNomad\Http\Interfaces\Request;

final class PaginationMiddleware implements Middleware
{
    public function __construct(
        private int $defaultNumber = 10,
        private int $maxNumber = 50
    ) {}

    public function process(Request $request): void
    {
        // Default page size
        if (!$request-&gt;hasParam('number')) {
            $request-&gt;setParam('number', $this-&gt;defaultNumber);
        }

        // Cap page size
        if ((int) $request-&gt;getParam('number') &gt; $this-&gt;maxNumber) {
            $request-&gt;setParam('number', $this-&gt;maxNumber);
        }

        // Default offset
        if (!$request-&gt;hasParam('offset')) {
            $request-&gt;setParam('offset', 0);
        }
    }
}
</code></pre>
<p><strong>Why this works well:</strong> controllers can rely on <code>number</code> and <code>offset</code> existing and living within bounds, without
duplicating that code in every endpoint.</p>
<h2 id="example-resolving-a-user-from-the-request">Example: resolving a user from the request</h2>
<p>This middleware looks up a record by ID and attaches the full record to the request. If the user doesn’t exist, it
throws a <code>RestException</code> with a <code>404</code> status code.</p>
<p>This is a common pattern for endpoints that operate on a specific resource. By the time the controller runs, it can
assume the user exists and focus on the business logic.</p>
<p>The power of this approach is that the logic to fetch the user and handle the &quot;not found&quot; case is isolated in one place,
and can be reused across multiple controllers, regardless of the datastore implementation.</p>
<pre><code class="language-php">&lt;?php

use PHPNomad\Rest\Interfaces\Middleware;
use PHPNomad\Http\Interfaces\Request;

final class GetRecordFromRequest implements Middleware
{
    public function __construct(
        protected Datastore $datastore,
        protected LoggerStrategy $logger
    ) {}

    public function process(Request $request): void
    {
        $id = $request-&gt;getParam('id');
        
        if(!$id) {
            throw new RestException(
                code: 400,
                message: &quot;Missing required 'id' parameter&quot;,
                context: []
            );
        }
        
        try{
            // Fetch the record and attach it to the request.
            $request-&gt;setParam('record', $this-&gt;datastore-&gt;find($id));
        } catch(RecordNotFoundException $e) {
            // If the record doesn't exist, stop the request with a 404.
            throw new RestException(
                code: 404,
                message: &quot;User {$id} was not found&quot;,
                context: ['id' =&gt; $id]
            );
        } catch(DatastoreErrorException $e) {
            // Log the error for internal tracking.
            $this-&gt;logger-&gt;logException($e);

            // For other errors, throw a 500 with context.
            // Note that the original exception is not exposed to the client.
            throw new RestException(
                code: 500,
                message: &quot;Error fetching user {$id}&quot;,
                context: ['id' =&gt; $id]
            );
        }
    }
}
</code></pre>
<h2 id="using-middleware-in-your-controllers">Using middleware in your controllers</h2>
<p>To attach middleware to a controller, implement the <code>PHPNomad\Rest\Interfaces\HasMiddleware</code> interface and define
<code>getMiddleware()</code>.</p>
<p>The example below shows a <code>GetUser</code> controller that uses the <code>GetRecordFromRequest</code> middleware to fetch a user by ID.
This uses the GetRecordFromRequest middleware defined above.</p>
<p>Note that before it passes the request to the middleware, it also
uses <a href="./included-middleware/set-type-middleware">SetTypeMiddleware</a> to ensure the <code>id</code> parameter is always an integer.</p>
<pre><code class="language-php">/**
 * Example controller showing how to get a user
 * - Middleware
 *
 * Each piece is isolated but works together in the request lifecycle.
 */
final class GetUser implements Controller, HasMiddleware
{
    public function __construct(
        private Response $response,                       // Response object (DI-provided)
        private UserDatastore $userDatastore,             // User datastore for middleware
        private UserAdapter $userAdapter,                 // User adapter for controller
        private GetRecordFromRequest $getRecordMiddleware // Middleware instance
    ) {}

    /**
     * The HTTP endpoint path where this controller is mounted.
     */
    public function getEndpoint(): string
    {
        return '/user/{id}';
    }

    /**
     * The HTTP method used for this endpoint.
     */
    public function getMethod(): string
    {
        return Method::Get;
    }

    /**
     * The core controller logic. This only runs if:
     * - Middleware passed (auth, type coercion, etc.)
     * - Validations succeeded
     */
    public function getResponse(Request $request): Response
    {
        // The &quot;record&quot; param is set by GetRecordFromRequest middleware.
        // Adapter converts it to a response-friendly format.
        $user = $this-&gt;userAdapter-&gt;toResponse(
            $request-&gt;getParam('record') // Set by middleware
        );

        // For gets, 200 is standard (with a body that includes the resource).
        return $this-&gt;response
            -&gt;setStatus(200)
            -&gt;setBody($user);
    }

    /**
     * Middleware runs *before* the controller logic.
     */
    public function getMiddleware(Request $request): array
    {
        return [
            new SetTypeMiddleware('id', BasicTypes::Integer), // Coerce 'id' to int
            $this-&gt;getRecordMiddleware
        ];
    }
}
</code></pre>

    </main>
</div>

<footer>
    <p class="mod--center">These docs were built with <a href="https://www.github.com/phpnomad/documentation">a static site generator that was made with PHPNomad.</a></p>
<small class="mod--center">Made and maintained by the people at <a href="https://www.novatori.us">Novatorius</a>. <em>Mente Nova!</em></small></footer>
</body>
</html>

